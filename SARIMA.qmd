---
title: "M√¥ h√¨nh SARIMA"
bibliography: references.bib
format: 
  html:
    code-fold: true
    code-tools: true
number-sections: true
---

# M√¥ h√¨nh SARIMA v√† SARIMAX:

## Chu·∫©n b·ªã d·ªØ li·ªáu

B·∫°n c√≥ th·ªÉ quay l·∫°i trang ƒë·∫ßu ti√™n ƒë·ªÉ l·∫•y d·ªØ li·ªáu g·ªëc v√† c√°c b∆∞·ªõc ƒë·ªÉ ch·ªânh s·ª≠a d·ªØ li·ªáu ·ªü [Gi·ªõi thi·ªáu](index.qmd).

```{r}
#| warning: false
#| message: false
#| echo: false

#Call packages:
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               lubridate,
               stringr
               )
#Import file:
product_demand<-import("C:\\Users\\locca\\Downloads\\Historical Product Demand.csv")

#Change to suitable class (I change the name dataset to product_demand to shortly write)
product_demand <-product_demand %>% 
    mutate(Date = as.Date(Date,format = "%Y/%m/%d"),
           Product_Category = as.factor(Product_Category))

product_demand$Order_Demand <- 
  gsub("[(]", "-", product_demand$Order_Demand)
product_demand$Order_Demand <- 
  gsub("[)]", "", product_demand$Order_Demand)
product_demand$Order_Demand <- 
  as.numeric(product_demand$Order_Demand)

#Then I will create a lot of cols contain year, month, week data and just select from 2012 to 2016:
product_demand <-product_demand %>%
  mutate(Month = month(Date),
         Year = year(Date),
         Week_day = wday(Date)) %>% 
  filter(Year %in% c(2016:2012))


#So I will calculate the total order demand divided by year and month:
month_df<-product_demand %>% 
  group_by(Year,Month) %>%   
  summarise(month_demand = round(sum(Order_Demand,
                               na.rm = T)/10^6,3)) %>% 
  mutate(datetime = as.Date(str_c(Year,
                                    Month,
                                    "1",
                                    sep = "-"))) %>% 
  ungroup() %>% 
  select(-c(Year,Month))

#First we will divde the data into training data and testing data in 70-30:
#Create ts object for month demand variable:
training_df<-month_df[month_df$datetime <= as.Date("2015-03-01"),]
testing_df <-month_df[month_df$datetime >= as.Date("2015-03-01"),]
#Transform it to ts object:
demand_training<-ts(training_df$month_demand,
                      frequency = 12,
                      start = c(2012,1))
demand_testing<-ts(testing_df$month_demand,
                frequency = 12,
                start = c(2015,3))
```

### M√¥ h√¨nh SARIMA:

Theo nghi√™n c·ª©u c·ªßa [@johna.miller2024],h·ªç nh·∫Øc ƒë·∫øn m√¥ h√¨nh SARIMAX c√≥ performance t·ªët h∆°n ARIMA. V·∫≠y SARIMAX l√† g√¨:

-   ƒê·ªãnh nghƒ©a: ARIMA ƒë√≥ng vai tr√≤ l√† n·ªÅn t·∫£ng ƒë·ªÉ l·∫≠p m√¥ h√¨nh d·ªØ li·ªáu kh√¥ng theo m√πa (*non-seasonal*), trong khi SARIMA m·ªü r·ªông kh·∫£ nƒÉng x·ª≠ l√Ω c√°c m·∫´u theo m√πa.

-   Th√†nh ph·∫ßn: SARIMAX c≈©ng x√¢y d·ª±ng d·ª±a tr√™n l√Ω thuy·∫øt nh∆∞ ARIMA nh∆∞ng th√™m 2 y·∫øu t·ªë m·ªõi l√† Seasonal v√† Exogenous variables. C√≤n m√¥ h√¨nh SARMA th√¨ ch·ªâ c√≥ th√™m y·∫øu t·ªë Seasonal.

Th·ª±c t·∫ø, m√¥ h√¨nh m√† R ƒë·ªÅ xu·∫•t tr√™n b·∫±ng h√†m `auto.arima()` c≈©ng ƒë√£ bao g·ªìm th√†nh ph·∫ßn *seasonal* n√™n ta c√≥ th·ªÉ xem m√¥ h√¨nh tr√™n SARIMA.

![H√¨nh 7: SARIMA VS ARIMA ](img/SARIMAX.png){fig-align="center"}

D∆∞·ªõi ƒë√¢y l√† v√≠ d·ª• v·ªÅ m√¥ h√¨nh SARIMA v√† c√°ch ƒë·ªÉ code trong R.

Gi·∫£i th√≠ch l·∫°i c√°c th√¥ng s·ªë ta s·ª≠ d·ª•ng s·∫Ω l√†:

-   (p,d,q) l√† b·∫≠c AR, m·ª©c ƒë·ªô kh√°c bi·ªát - Difference v√† b·∫≠c MA.

-   (P,D,Q) l√† b·∫≠c seasonal c·ªßa m√¥ h√¨nh.

-   \[s\] (period arguments) l√† th√¥ng s·ªë cho pattern. V√≠ d·ª• trong d·ªØ li·ªáu n√†y l√† d·ªØ li·ªáu c·ªßa 12 th√°ng n√™n `period = 12`. B·∫°n c√≥ th·ªÉ g·∫∑p d·ªØ li·ªáu theo qu√Ω th√¨ `period = 3`, d·ªØ li·ªáu theo nƒÉm th√¨ `period = 1`.

V·∫≠y th√¨ c√≤n m√¥ h√¨nh SARIMAX th√¨ kh√°c g√¨ v·ªõi SARIMA.

### M√¥ h√¨nh SARIMAX:

ƒê·ªÉ x√¢y d·ª±ng m√¥ h√¨nh SARIMAX th√¨ ta c·∫ßn th√™m 1 bi·∫øn kh√°c kh√¥ng ph·∫£i l√† bi·∫øn qu√° kh·ª© c·ªßa d·ªØ li·ªáu. G·ªâa s·ª≠ ta t·∫°o th√™m 1 bi·∫øn l√† thu nh·∫≠p b√¨nh qu√¢n c·ªßa ng∆∞·ªùi d√¢n trong kho·∫£ng th·ªùi gian ƒë√≥.

```{r}
#| warning: false
#| message: false
# T·∫°o bi·∫øn m·ªõi thu nh·∫≠p b√¨nh qu√¢n:
income<-ts(data = runif(nrow(month_df),100,500),
           frequency = 12,
           start = c(2012,1))

library(forecast)
ggtsdisplay(income,
            main = "Time-series plot of median income")
```

Sau ƒë√≥ ta x√¢y d·ª±ng m√¥ h√¨nh nh∆∞ c√°c b∆∞·ªõc c≈©:

```{r}
#| warning: false
#| message: false
#Forecast by training model:
model_training2<-Arima(demand_training,
             xreg = income[1:length(demand_training)],
             order = c(3,1,3),
             seasonal = list(order = c(1,1,0),
                             period = 12),
             lambda = NULL,
             include.constant = TRUE)

checkresiduals(model_training2,
               theme = theme_bw())
```

```{r}
#| warning: false
#| message: false
training_forecast2<-forecast(model_training2,
                             xreg = income[39:nrow(month_df)],
                             h = 21)

#Use chart for presenting the differents:
plot(training_forecast2,
      main = str_glue("Model ARIMA(2,0,0)"),
      xlab = "Time",
      ylab = "Order Demand")
lines(demand_testing, 
      col = "red",
      lwd = "2")
legend("topleft",
       legend = c("Actual","Forecast"),
       col = c("red","blue"),
       box.lty = 0,
       lty = 1,
       cex = 1,
       lwd = 2)

```

V√† sau ƒë√≥, ta s·∫Ω s·ª≠ d·ª•ng model ƒë√≥ ƒë·ªÉ d·ª± ƒëo√°n cho t∆∞∆°ng lai. Nh√¨n bi·ªÉu ƒë·ªì ta d·ªÖ d√†ng k·∫øt lu·∫≠n m√¥ h√¨nh kh√¥ng t·ªët. Nguy√™n do l√† t∆∞∆°ng quan gi·ªØa bi·∫øn `income` v√† `demand_training` qu√° th·∫•p, ch·ªâ s·ªë t∆∞∆°ng quan ch·ªâ c√≥ `r round(cor(income[1:length(demand_training)],demand_training),3)`.

# Ph∆∞∆°ng ph√°p th·ªß c√¥ng:

## L·ª±a ch·ªçn m√¥ h√¨nh th·ªß c√¥ng:

Th·ª±c t·∫ø, ta th·∫•y m√¥ h√¨nh do R ƒë·ªÅ xu·∫•t b·∫±ng h√†m `auto.arima` c√≥ v·∫ª "overfitting" - nghƒ©a l√† m√¥ h√¨nh t·ªët qu√°, *cover* h·∫øt c√°c tr∆∞·ªùng h·ª£p nh∆∞ng c√≥ nguy c∆° kh√¥ng cho d·ª± ƒëo√°n t·ªët v√¨ d·ªØ li·ªáu trong t∆∞∆°ng lai bi·∫øn ƒë·ªông.

V√¨ v·∫≠y, ta c√≥ th·ªÉ x√¢y d·ª±ng c√°ch l·ª±a ch·ªçn m√¥ h√¨nh theo c√°ch kh√°c. M√¨nh c√≥ kham kh·∫£o c√°ch n√†y tr√™n [How can I select the best SARIMA model](https://malouche.github.io/howto/sarima.html).

```{r}
#| warning: false
#| message: false
## List all parameters can be appeared:
qQ=list()
for(i in 1:14) qQ[[i]]=c(i-1,0)
qQ[[15]]=c(0,1)
qQ[[16]]=c(1,1)
pP=qQ
 
dt_params=c()
for(i in 1:16){
  for(j in 1:16){
     temp=c(pP[[i]][1],1,qQ[[j]][1],pP[[i]][2],1,
            qQ[[j]][2],12)
     dt_params=rbind(temp,dt_params)
   }
 }
colnames(dt_params)=c("p","d","q","P","D","Q","T")
rownames(dt_params)=1:256

# Build all the models:
models=vector("list",256)
for(i in 1:256){
   try(models[[i]]<-Arima(diff(demand_training,lag = 1),
                          order = dt_params[i,1:3],
                          seasonal = list(order=dt_params[i,4:6],
                                          period=12),
                     lambda = NULL,
                     method="ML"))  ## use MLE (maximum likelihood estimation)
}
```

Sau khi ƒë√£ x√¢y d·ª±ng h·∫øt c√°c m√¥ h√¨nh b·∫±ng 256 th√¥ng s·ªë. Ta s·∫Ω ki·ªÉm tra gi·∫£ thuy·∫øt v·ªÅ t√≠nh ƒë·ªôc l·∫≠p trong m·ªôt chu·ªói th·ªùi gian nh·∫•t ƒë·ªãnh (*White noise*) - nghƒ©a l√† ki·ªÉm tra ph·∫ßn d∆∞ (*residuals*) c·ªßa m√¥ h√¨nh c√≥ ph·∫£i l√† *random noise* kh√¥ng ?

```{r}
#| warning: false
#| message: false
## Applied Ljung-Box Tests:
aa=rep(NA,256)
for(i in 1:256){
   if(length(models[[i]]$residuals)>1){
     a=Box.test(x = models[[i]]$residuals,
                lag = 10,
                type = "Box-Pierce")
     z=prod(1-(a[["p.value"]]<.05))
     if(z==1) aa[i]="Passed"
     else aa[i]="Failed"
   }
}

## Transfers all these information into 1 table:
dt_params2=data.frame(dt_params)
dt_params2$residuals=aa

aic=rep(NA,256)
model_names=rep(NA,256)
for(i in 1:256){
   if(length(models[[i]]$aic)>0){
     aic[i]=models[[i]]$aic
     model_names[i]=as.character(models[[i]])
   }
}
dt_params2$aic=aic
dt_params2$model=model_names
```

Cu·ªëi c√πng tr√¨nh b√†y b·∫£ng 10 model t·ªët nh·∫•t v·ªõi 2 ƒëi·ªÅu ki·ªán:

-   Ch·ªâ s·ªë AIC th·∫•p trong top 10.
-   Ch·ªâ s·ªë p c·ªßa Ljung-Box Test \< 0.05.

V√† m√¥ h√¨nh cu·ªëi c√πng ƒë∆∞·ª£c ch·ªçn l√† ARIMA(2,1,0)(0,1,0)\[12\] v·ªõi ch·ªâ s·ªë AIC l√† 189.8917.

```{r}
## Finally plot the table and compared the AIC and BIC value among models:
gt<-dt_params2[order(dt_params2$aic,decreasing = FALSE),][1:10,] %>%
     filter(residuals == "Passed") %>% ### Just select the models with p < 0.05
     relocate(model)
## Just select 10 best models:


library(gt)
library(gtExtras)
gt(gt) %>% 
  cols_align(
    align = "left",
    columns = "model"
  ) %>% 
    cols_label(
    model = md("**Model**"),
    aic = md("**AIC value**")) %>%
   tab_header(
    title = md("**Ljung‚ÄìBox test**"),
    subtitle = glue::glue("Time from {min(training_df$datetime)} to {max(training_df$datetime)}")) %>%
   tab_source_note(
    source_note = "Null hypothesis: a given time series is independence") %>% 
  gt_theme_538() %>% 
  gt_highlight_rows(rows = 1, 
                    font_weight = "normal")

```

## ƒê√°nh gi√° m√¥ h√¨nh:

V√† cu·ªëi c√πng l√† ƒë√°nh gi√° m√¥ h√¨nh v·ª´a ƒë∆∞·ª£c ch·ªçn ARIMA(2,1,0)(0,1,0)\[12\] v·ªõi d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ ƒë·ªëi t∆∞·ª£ng `demand_testing`.

```{r}
#| warning: false
#| message: false
#Forecast by training model:
model_training3<-Arima(diff(demand_training,lag = 1),
                       order = c(2,1,1),
                       seasonal = list(order = c(0,1,0),
                                       period = 12),
             lambda = NULL)

training_forecast3<-forecast(model_training3,
                             h = 21)

#Use chart for presenting the differents:
plot(training_forecast3,
      main = glue::glue("Model {gt[['model']][1]}"),
      xlab = "Time",
      ylab = "Order Demand")
lines(diff(demand_testing,lag = 1), 
      col = "red",
      lwd = "2")
legend("topleft",
       legend = c("Actual","Forecast"),
       col = c("red","blue"),
       box.lty = 0,
       lty = 1,
       cex = 1,
       lwd = 2)
```

## Ki·ªÉm ƒë·ªãnh gi·∫£ thuy·∫øt c·ªßa m√¥ h√¨nh:

Sau khi ƒë√£ x√¢y d·ª±ng m√¥ h√¨nh, ta c·∫ßn ki·ªÉm tra l·∫°i c√°c gi·∫£ thuy·∫øt nh∆∞:

-   Ph·∫ßn d∆∞ kh√¥ng t∆∞∆°ng quan.
-   Ph·∫ßn d∆∞ c√≥ trung b√¨nh l√† 0.
-   ph∆∞∆°ng sai kh√¥ng ƒë·ªïi
-   Ph·∫ßn d∆∞ c√≥ ph√¢n ph·ªëi chu·∫©n.

```{r}
#| warining: false
#| message: false
## Diagnostics the ARRIMA model in a short command:
checkresiduals(model_training3,
               theme = theme_bw())
```

N·∫øu so s√°nh v·ªõi m√¥ h√¨nh ban ƒë·∫ßu theo c√°ch `auto.arima` th√¨ c√≥ v·∫ª m√¥ h√¨nh n√†y t·ªá h∆°n. Nh∆∞ng c√≥ th·ªÉ ·ªü trong t∆∞∆°ng lai, m√¥ h√¨nh n√†y c√≥ th·ªÉ s·∫Ω t·ªët h∆°n chƒÉng.

```{r}
## Calculating MAE metric:
sum = 0
for (i in 1:21){ 
  sum = abs(diff(demand_testing,lag = 1)[i]-training_forecast3$mean[i])+sum
} 

MAE = sum/21

## Calculating RMSE metric:
RMSE = sqrt(mean((diff(demand_testing,lag = 1) - training_forecast3$mean)^2))

## Plot the compared results:
gt(data.frame(Metric = c("MAE","RMSE"),
              Manual = c(MAE,RMSE),
              Auto.Arima = c(6.428828,7.534382))) %>% 
  cols_label(
    Manual = md("**Manual method**"),
    Auto.Arima = md("**Auto.Arima method**")) %>%
  cols_align(
    align = "center",
    columns = "Manual"
  ) %>% 
  cols_align(
    align = "center",
    columns = "Auto.Arima"
  ) %>% 
  tab_header(
    title = md("**Comparing the accuracy of forecasting**"),
    subtitle = glue::glue("Forecasting from {min(testing_df$datetime)} to {max(testing_df$datetime)}")) %>%
   tab_source_note(
    source_note = str_glue("Between Manual and Auto ARIMA Method")) %>% 
  gt_theme_538() %>% 
  gt_highlight_cols(Auto.Arima, 
                    fill = "blue", 
                    alpha = 0.5)
```

# D·ª± ƒëo√°n s·ªë ƒë∆°n h√†ng trong 18 th√°ng ·ªü t∆∞∆°ng lai:

D∆∞·ªõi ƒë√¢y l√† k·∫øt qu·∫£ d·ª± ƒëo√°n t·ª´ m√¥ h√¨nh trong 3 nƒÉm ti·∫øp theo ~ 18 th√°ng.

```{r}
#| warning: false
#| message: false

demand_full<-ts(month_df$month_demand,
                      frequency = 12,
                      start = c(2012,1))

#Predicting for 18 months with 99.5% range:
predict_fit<-forecast:::forecast.Arima(model_training3,
                                       h = 18, 
                                       level = c(99.5)) 

#Transform to data.frame object:
df<-predict_fit %>% 
  as.data.frame() %>% 
  mutate(Period = seq(max(month_df$datetime),
                    max(month_df$datetime)+months(18), 
                    by= "1 month")[-1]) %>% 
  relocate(Period)
```

```{r}
#| warning: false
#| message: false
#| layout: [[50,50], [100]]
gt(df[1:9,]) %>% 
  tab_header(
    title = md("**Forecasting Order Demand**"),
    subtitle = glue::glue("Time from {max(month_df$datetime)} to {max(month_df$datetime)+months(9)}")) %>%
   tab_source_note(
    source_note = glue::glue("Method: Model {gt[['model']][1]}")) %>% 
  gt_theme_538() 

gt(df[10:18,]) %>% 
  tab_header(
    title = md("**Forecasting Order Demand**"),
    subtitle = glue::glue("Time from {max(month_df$datetime)+months(9)} to {max(month_df$datetime)+months(18)}")) %>%
  gt_theme_538() 

#Plot the forecast value
forecast:::plot.forecast(predict_fit, 
     xlab ="Time",
     ylab = "Order demand")
```

V·∫≠y ch√∫ng ta ƒë√£ k·∫øt th√∫c b√†i post ng√†y h√¥m nay.

N·∫øu b·∫°n c√≥ c√¢u h·ªèi hay th·∫Øc m·∫Øc n√†o, ƒë·ª´ng ng·∫ßn ng·∫°i li√™n h·ªá v·ªõi m√¨nh qua Gmail. B√™n c·∫°nh ƒë√≥, n·∫øu b·∫°n mu·ªën xem l·∫°i c√°c b√†i vi·∫øt tr∆∞·ªõc ƒë√¢y c·ªßa m√¨nh, h√£y nh·∫•n v√†o hai n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ truy c·∫≠p trang **Rpubs** ho·∫∑c m√£ ngu·ªìn tr√™n **Github**. R·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h√†nh c√πng b·∫°n, h·∫πn g·∫∑p l·∫°i! üòÑüòÑüòÑ

```{=html}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Me</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; }
        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        label { display: block; margin: 10px 0 5px; }
        input[type="email"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }
        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }
        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }
        .rpubs-button button { background-color: #75AADB; }
        .rpubs-button button:hover { background-color: #5A9BC2; }
        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Contact Me</h2>
        <form id="emailForm">
            <label for="email">Your Email:</label>
            <input type="email" id="email" name="email" required aria-label="Email Address">
            <div class="error-message" id="error-message" style="display: none;">Please enter a valid email address.</div>
            <button type="submit">Send Email</button>
        </form>
        <div class="github-button">
            <button>
                <a href="https://github.com/Loccx78vn" target="_blank" style="color: white; text-decoration: none;">
                    <i class="fab fa-github"></i> View Code on GitHub
                </a>
            </button>
        </div>
        <div class="rpubs-button">
            <button>
                <a href="https://rpubs.com/loccx" target="_blank" style="color: white; text-decoration: none;">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg" alt="RStudio icon" class="rpubs-icon"> Visit my RPubs
                </a>
            </button>
        </div>
    </div>

    <script>
        document.getElementById('emailForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            const emailInput = document.getElementById('email');
            const email = emailInput.value;
            const errorMessage = document.getElementById('error-message');

            // Simple email validation regex
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailPattern.test(email)) {
                errorMessage.style.display = 'none'; // Hide error message
                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;
                window.open(gmailLink, '_blank'); // Open in new tab
            } else {
                errorMessage.style.display = 'block'; // Show error message
            }
        });
    </script>
</body>
</html>
```
